<!doctype html>
<html>
<head>
    <script src="/engine/build/output/playcanvas-latest.js"></script>
    <style>
        html, body {
            margin: 0px;
            padding: 0px;
        }
    </style>
</head>

<body>
    <!-- The canvas element -->
    <canvas id="application-canvas"></canvas>

    <!-- The script -->
    <script>
        var canvas = document.getElementById("application-canvas");

        // Create the application and start the update loop
        var application = new pc.fw.Application(canvas);
        application.start();

        // Set the canvas to fill the window and automatically change resolution to be the same as the canvas size
        application.setCanvasFillMode(pc.fw.FillMode.FILL_WINDOW);
        application.setCanvasResolution(pc.fw.ResolutionMode.AUTO);

        application.context.scene.ambientLight = new pc.Color(0.2, 0.2, 0.2);


        function loadModel (url, assets) {
            // Create Assets
            var modelAsset = new pc.asset.Asset("MCCV", "model", {
                url: url
            });

            var parts = pc.path.split(url);
            parts[1] = parts[1].replace(".json", ".mapping.json");
            var mappingUrl = pc.path.join(parts[0], parts[1]);

            var mappingAsset = new pc.asset.Asset("mapping", "json", {
                url: mappingUrl
            });

            // Load Assets
            var promise = assets.load([modelAsset, mappingAsset]);

            promise.then(function (resources) {
                var model = resources[0];
                var mapping = resources[1];

                var dir = pc.path.getDirectory(url);

                var materialAssets = [];
                mapping.mapping.forEach(function (map) {
                    materialAssets.push(new pc.asset.Asset(pc.path.getBasename(map.path), "material", {
                        url: pc.path.join(dir, map.path)
                    }));
                });

                return assets.load(materialAssets).then(function (materials) {
                    for(var i = 0, n = model.meshInstances.length; i < n; i++) {
                        model.meshInstances[i].material = materials[i];
                    }

                    scene.addModel(model);
                });
            });

            return promise;
        }

        var ship, light, camera;

        loadModel("../assets/ship/MCCV-2.json", application.context.assets).then(function (models) {
            var ship = new pc.fw.Entity();
            var asset = application.context.assets.getAssetByUrl("../assets/ship/MCCV-2.json");
            application.context.systems.model.addComponent(ship, {
                type: "asset",
                asset: asset
            });
            ship.rotate(0, 45, 0);
            application.context.root.addChild(ship);
        });

        // var modelAsset = new pc.asset.Asset("MCCV", "model", {
        //     url: "../assets/ship/MCCV-2.json",
        //     hash: 1
        // });

        // var materialAsset = new pc.asset.Asset("ship_hull_1Mat", "material", {
        //     url: "../assets/ship/material.json",
        //     hash: 2
        // });

        // var textureAsset = new pc.asset.Asset("texture1", "texture", {
        //     url: "../assets/ship/texture1.png",
        //     hash: 3
        // });

        // var specularAsset = new pc.asset.Asset("text-spec", "texture", {
        //     url: "../assets/ship/text-spec.png",
        //     hash: 4
        // });

        // application.context.assets.load([modelAsset, materialAsset, textureAsset, specularAsset]).then(function (resources) {

        //     var model = resources[0];
        //     var material = resources[1];

        //     material.diffuseMap = resources[2];
        //     material.specularMap = resources[3];
        //     material.update();

        //     model.meshInstances[0].material = material;

        //     var ship = new pc.fw.Entity();
        //     application.context.systems.model.addComponent(ship, {
        //         type: "asset",
        //         asset: modelAsset
        //     });
        //     ship.rotate(0, 45, 0);
        //     application.context.root.addChild(ship);
        // });

        // Create an Entity with a camera component
        var camera = new pc.fw.Entity();
        application.context.systems.camera.addComponent(camera, {
            clearColor: new pc.Color(0.8, 0.8, 0.8)
        });
        camera.translate(0, 0, 2);

        // Create an Entity with a point light component and a sphere model component.
        var light = new pc.fw.Entity();
        application.context.systems.light.addComponent(light, {
            type: "point",
            color: new pc.Color(1, 1, 1),
            radius: 100
        });
        application.context.systems.model.addComponent(light, {
            type: "sphere"
        });
        // Scale the sphere down to 0.1m
        light.setLocalScale(0.1, 0.1, 0.1);
        light.translate(0, 0.4, 2);

        application.context.root.addChild(camera);
        application.context.root.addChild(light);
    </script>
</body>
</html>
