<!doctype html>
<html>
<head>
    <script src="/engine/build/output/playcanvas-latest.js"></script>
    <style>
        html, body {
            margin: 0px;
            padding: 0px;
        }

        canvas {
            height: 720px;
            width: 1200px;
        }
    </style>
</head>

<body>
    <!-- The canvas element -->
    <canvas id="application-canvas" width="1200" height="720"></canvas>

    <!-- The script -->
    <script>
        var canvas = document.getElementById("application-canvas");

        // Create the graphics device
        var device = new pc.gfx.Device(canvas);

        // Create renderer
        var renderer = new pc.scene.ForwardRenderer(device);

        // Create Scene
        var scene = new pc.scene.Scene();

        // Create camera node
        var camera = new pc.scene.CameraNode();
        camera.setLocalPosition(0,1,2);

        // Set up a default scene light
        var light = new pc.scene.LightNode();
        light.setType(pc.scene.LIGHTTYPE_POINT);
        light.setAttenuationEnd(100);
        light.setLocalPosition(0, 2, 2);
        light.setEnabled(true);
        scene.addLight(light);

        // Create resource and asset loaders
        var loader = new pc.resources.ResourceLoader();
        var assets = new pc.asset.AssetRegistry(loader);
        // Register loaders for models, textures and materials
        loader.registerHandler(pc.resources.MaterialRequest, new pc.resources.MaterialResourceHandler(assets));
        loader.registerHandler(pc.resources.TextureRequest, new pc.resources.TextureResourceHandler(device));
        loader.registerHandler(pc.resources.ModelRequest, new pc.resources.ModelResourceHandler(device, assets));
        loader.registerHandler(pc.resources.JsonRequest, new pc.resources.JsonResourceHandler());

        function loadModel (url, assets) {
            // Create Assets
            var modelAsset = new pc.asset.Asset("MCCV", "model", {
                url: url
            });

            var parts = pc.path.split(url);
            parts[1] = parts[1].replace(".json", ".mapping.json");
            var mappingUrl = pc.path.join(parts[0], parts[1]);

            var mappingAsset = new pc.asset.Asset("mapping", "json", {
                url: mappingUrl
            });

            // Load Assets
            var promise = assets.load([modelAsset, mappingAsset]);

            promise.then(function (resources) {
                var model = resources[0];
                var mapping = resources[1];

                var dir = pc.path.getDirectory(url);

                var materialAssets = [];
                mapping.mapping.forEach(function (map) {
                    materialAssets.push(new pc.asset.Asset(pc.path.getBasename(map.path), "material", {
                        url: pc.path.join(dir, map.path)
                    }));
                });

                return assets.load(materialAssets).then(function (materials) {
                    for(var i = 0, n = model.meshInstances.length; i < n; i++) {
                        model.meshInstances[i].material = materials[i];
                    }
                });
            });

            return promise;
        }

        var model = null;
        loadModel("../assets/test/modelskinrig.json", assets).then(function (resources) {
            model = resources[0];

            scene.addModel(model);
        });

        // Setup update, render and tick functions
        var update = function (dt) {
            if (model) {
                model.getGraph().rotate(0, 90*dt, 0);
            }
            scene.update();
        };

        var render = function () {
            renderer.render(scene, camera);
        }

        var time = 0;
        var tick = function () {
            var now = (window.performance && window.performance.now) ? performance.now() : Date.now();
            var dt = (now - (time || now)) / 1000.0;
            time = now;

            update(dt);
            render();

            requestAnimationFrame(tick, canvas);
        }

        // start running
        tick();
    </script>
</body>
</html>
